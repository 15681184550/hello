<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>消息</title>
    <link rel="stylesheet" href="../../css/mui.min.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8"/>
</head>
<style>
	.sw-link{
		color: #666;
		border: 1px solid #efefef;
		height: 48px;
		line-height: 48px;
		text-align: left;
		width: 240px;
		margin: auto;
		border-radius: 24px;
		font-size: 14px;
		padding-left: 24px;
	}
	.sw-card-header{
		padding-right: 10%!important;
	}
	.sw-card-header:after{
		background: none!important;
	}
	.sw-card-body{
		background: #f5f5f5;margin-top: 4px;border: 1px solid #DDDDDD;border-radius: 6px;padding: 10px;
	}
	.sw-card-a1{
		word-break: break-all;width: 90%;height: auto;background: #FFFFFF;padding: 8px;margin-top: 4px;border: 1px solid #DDDDDD;
	}
	.sw-card-a2{
		word-break: break-all;
	}
	.sw-card-a3{
		margin-left: 38px;color: #666;word-break:keep-all;white-space:normal;
	}
	.sw-card-red{
		color: #fd524b;
	}
	.sw-card-hr{
		height: 1px;border: none;background: #DDDDDD;
	}
	.sw-card-t1{
		line-height: 18px;font-size: 12px;
	}
	
	/*//下拉加载*/
	.mui-bar~.mui-content .mui-fullscreen {
		top: 44px;
		height: auto;
	}
	.mui-pull-top-tips {
		position: absolute;
		top: -20px;
		left: 50%;
		margin-left: -25px;
		width: 40px;
		height: 40px;
		border-radius: 100%;
		z-index: 1;
	}
	.mui-bar~.mui-pull-top-tips {
		top: 24px;
	}
	.mui-pull-top-wrapper {
		width: 42px;
		height: 42px;
		display: block;
		text-align: center;
		background-color: #efeff4;
		border: 1px solid #ddd;
		border-radius: 25px;
		background-clip: padding-box;
		box-shadow: 0 4px 10px #bbb;
		overflow: hidden; 
	}
	.mui-pull-top-tips.mui-transitioning {
		-webkit-transition-duration: 200ms;
		transition-duration: 200ms;
	}
	.mui-pull-top-tips .mui-pull-loading {
		/*-webkit-backface-visibility: hidden;
		-webkit-transition-duration: 400ms;
		transition-duration: 400ms;*/
		
		margin: 0;
	}
	.mui-pull-top-wrapper .mui-icon,
	.mui-pull-top-wrapper .mui-spinner {
		margin-top: 7px;
	}
	.mui-pull-top-wrapper .mui-icon.mui-reverse {
		/*-webkit-transform: rotate(180deg) translateZ(0);*/
	}
	.mui-pull-bottom-tips {
		text-align: center;
		background-color: #efeff4;
		font-size: 15px;
		line-height: 40px;
		color: #777;
	}
	.mui-pull-top-canvas {
		overflow: hidden;
		background-color: #fafafa;
		border-radius: 40px;
		box-shadow: 0 4px 10px #bbb;
		width: 40px;
		height: 40px;
		margin: 0 auto;
	}
	.mui-pull-top-canvas canvas {
		width: 40px;
	}
	.mui-slider-indicator.mui-segmented-control {
		background-color: #efeff4;
	}
	.mui-popup-button:after {
		width: 0px;
	}
	.mui-popup-inner:after {
		height: 0px;
	}
	.mui-popup-button:first-child:last-child {
		border-radius: 4px;
	}
	.sw-popu-btn{
		width:70%;height:36px;line-height:14px;border-radius: 1px;margin: auto;font-size: 16px;
	}
</style>
<body style="background: #FFFFFF;">
	<header class="mui-bar mui-bar-nav">
	    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	    <h1 class="mui-title">消息</h1>
	</header>
	
	<div class="mui-content" style="background: #FFFFFF;" id="msgList">
		
		<!--<div class="mui-card-header mui-card-media sw-card-header">
			<img src="../../image/msg/icon_xiaoxi.png"/>
			<div class="mui-media-body sw-card-body">			
				 你有一个来至港中旅国际成都旅行社丰德分社-签证的签证产品审核申请,签证产品名称：俄罗斯 旅游签证,点击签证审核 前往处理吧！！
				<p style="margin-top: 4px;">2016-06-30 15:30</p> 
			</div>
		</div>
		
		<div class="mui-card-header mui-card-media sw-card-header">
			<img src="../../image/msg/icon_xiaoxi.png"/>
			<div class="mui-media-body sw-card-body">			
				 你有一条新的求购匹配
				 <div class="sw-card-a1">
				 	英菲迪尼
				 	<p  style="line-height: 24px;">英菲迪尼Q70L(进口)</p>
				 	<p class="sw-card-t1">配件数：1</p>
				 	<hr class="sw-card-hr">
				 	<p style="margin-top: 4px;">2016-06-30 15:30<span class="sw-card-red" style="float: right;">有效期1天</span></p> 
				 </div>
			</div>
		</div>
		
		<div class="mui-card-header mui-card-media sw-card-header">
			<img src="../../image/msg/icon_xiaoxi.png"/>
			<div class="mui-media-body sw-card-body">			
				 某某某评价了您的动态
				 <div class="sw-card-a1">
				 	<div class="sw-card-a2"><span class="sw-card-red">昵称</span>：评论的文字内容评论的文字内容评论的文字内容</div>	 
				 </div>
			</div>
		</div>
		
		<div class="mui-card-header mui-card-media sw-card-header">
			<img src="../../image/msg/icon_xiaoxi.png"/>
			<div class="mui-media-body sw-card-body">			
				 你的店铺被该经销商访问
				 <div class="sw-card-a1">
				 	<span class="sw-card-red">三和英菲迪尼</span>
				 	<div style="margin-top: 4px;">
				 		<div style="float: left;">[主营]</div>
				 		<div class="sw-card-a3">一汽丰田：克莱斯勒 林肯 乔治·巴顿  山姆  赛麟SALEEN 特斯拉  雪佛兰  克莱斯勒 林肯 乔治·巴顿  山姆  赛麟SALEEN 特斯拉  雪佛兰</div>
				 	</div>
				 </div>
			</div>
		</div>
		
		<div class="mui-card-header mui-card-media sw-card-header">
			<img src="../../image/msg/icon_xiaoxi.png"/>
			<div class="mui-media-body sw-card-body">			
				 你的店铺被该汽修厂/美容店访问
				 <div class="sw-card-a1">
				 	<span class="sw-card-red">汽修厂/美容店</span> 
				 </div>
			</div>
		</div>-->
		
	</div>
	<div id="loadList"><input value="1" hidden="hidden" id="page"/></div>
<!--列表模板-->
<script id="msg-list-tpl" type="text/html">
	{{# var len = d.length; }} 	
	{{# for(var i = 0;i < len; i++){ }}
		
	{{# if(d[i].msgType==1){ }}	
	<div class="mui-card-header mui-card-media sw-card-header">
		<img src="../../image/msg/icon_xiaoxi.png"/>
		<div class="mui-media-body sw-card-body">			
			 {{ d[i].msgText }} 
			<p style="margin-top: 4px;">{{ d[i].createTime }}</p> 
		</div>
	</div>
	{{# }else if(d[i].msgType==3){ }}
		<div class="mui-card-header mui-card-media sw-card-header" onclick="qiugouDetail('{{ d[i].aboutId }}')">
			<img src="../../image/msg/icon_xiaoxi.png"/>
			<div class="mui-media-body sw-card-body">			
				 {{ d[i].msgText }} 
				 <div class="sw-card-a1">
				 	{{ d[i].info.car12Str }}
				 	<p  style="line-height: 24px;">{{ d[i].info.car34Str }}</p>
				 	<p class="sw-card-t1">配件数：{{ d[i].info.paiS }}</p>
				 	<hr class="sw-card-hr">
				 	<p style="margin-top: 4px;">{{ d[i].info.create_time }}<span class="sw-card-red" style="float: right;">有效期{{ d[i].info.limitation }}天</span></p> 
				 </div>
			</div>
		</div>
	{{# }else if(d[i].msgType==4){ }}
		<div class="mui-card-header mui-card-media sw-card-header" onclick="pinglun22('{{ d[i].aboutId }}')">
			<img src="../../image/msg/icon_xiaoxi.png"/>
			<div class="mui-media-body sw-card-body">			
				 {{ d[i].msgText }} 
				 <div class="sw-card-a1">
				 	<div class="sw-card-a2"><span class="sw-card-red">{{ d[i].info.uname }}</span>：{{ d[i].info.content }}</div>	 
				 </div>
			</div>
		</div>
	{{# }else if(d[i].msgType==5){ }}
		<div class="mui-card-header mui-card-media sw-card-header" onclick="pinglun22('{{ d[i].aboutId }}')">
			<img src="../../image/msg/icon_xiaoxi.png"/>
			<div class="mui-media-body sw-card-body">			
				{{ d[i].msgText }} 
				 <div class="sw-card-a1">
				 	<div class="sw-card-a2"><span class="sw-card-red">{{ d[i].info.uname }}</span>：{{ d[i].info.content }}</div>	 
				 </div>
			</div>
		</div>
	{{# }else if(d[i].msgType==6){ }}
	
	{{# if(d[i].info.type==1){ }}
	<div class="mui-card-header mui-card-media sw-card-header" onclick="openFirm('{{ d[i].aboutId }}')">
		<img src="../../image/msg/icon_xiaoxi.png"/>
		<div class="mui-media-body sw-card-body">			
			 {{ d[i].msgText }} 
			 <div class="sw-card-a1">
			 	<span class="sw-card-red">{{ d[i].info.companyname }}</span>
			 	<div style="margin-top: 4px;">
			 		<div style="float: left;">[主营]</div>
			 		<div class="sw-card-a3" style="word-break: break-all;">{{ d[i].info.major }}</div>
			 	</div>
			 </div>
		</div>
	</div>
	{{# }else{ }}
	<div class="mui-card-header mui-card-media sw-card-header" onclick="openFirm('{{ d[i].aboutId }}')">
		<img src="../../image/msg/icon_xiaoxi.png"/>
		<div class="mui-media-body sw-card-body">			
			 {{ d[i].msgText }} 
			 <div class="sw-card-a1">
			 	<span class="sw-card-red">{{ d[i].info.companyname }}</span> 
			 </div>
		</div>
	</div>
	{{# } }}
	
	{{# }else{ }}
	
	{{# } }}
	{{# } }}
</script>
</body>
 <script src="../../js/mui.min.js"></script>
 <script src="../../js/global.js"></script>
 <script src="../../js/jquery.min.js"></script>
<script src="../../js/laytpl/laytpl.js"></script>
<script src="../../js/mui.pullToRefresh.js"></script>
<script src="../../js/mui.pullToRefresh.material.js"></script>
  <script type="text/javascript" charset="utf-8"> 
 //mui初始化
	mui.init({  
	  pullRefresh : {
	    container:'#loadList',//待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
	    up : {
	      height:50,//可选.默认50.触发上拉加载拖动距离
	      auto:true,//可选,默认false.自动上拉加载一次
	      contentrefresh : "正在加载...",//可选，正在加载状态时，上拉加载控件上显示的标题内容
	      contentnomore:'没有更多消息记录了',//可选，请求完毕若没有更多数据时显示的提醒内容；
	      callback :function(){	
	      	getStartList(false);
	      } //必选，刷新函数
	    }
	  } 
	});
	
	//mui plusReady
	mui.plusReady(function() {	
	
		//监控页面是否登录
		if(UserInfo.has_login()){	//如果已经登录将新闻清空	
			var token   = plus.storage.getItem('token');			
			var postData = {};
				postData.token = token;
				postData.userType = JsonStorage.getItem('userType');	//2为业务员
			//如果已经登陆 获取登录后的数据 
			http.load('api.sev.article','clearNotice',postData,function(rData){//请求成功	 
	 	})
			
			//刷新首页    圈子   通知公告  个人中心 消息提示
			 plus.webview.getWebviewById("view/index/index.html").reload(true);
			 plus.webview.getWebviewById("view/coterie/list.html").reload(true);
			 plus.webview.getWebviewById("view/gonggao/notice.html").reload(true);
			 plus.webview.getWebviewById("view/person/index.html").reload(true);
		}  
		
	})
	
	//循环初始化所有下拉刷新，上拉加载。
	mui("body").pullToRefresh({
		down: {
			callback: function() {				
				var self = this;
				reGetInfo(self);				
			}
		}   
	});				

	/**
	 * 重新获取数据
	 * @param {Object} type
	 * @param {Object} j
	 */
 	function reGetInfo(self){		
 		//清空数据
		$("#msgList").html('');
		$("#page").val(1);
		//从新开始加载数据 
		 getStartList(self);
		//加载标记								
		mui('#loadList').pullRefresh().refresh(true); 
					
 	}


	 //从新开始加载数据 
	 function getStartList(isDown){
	 	var token = plus.storage.getItem('token');
	 	var page  = mui("#page")[0].value;//获取页数							
      	var data  = {};  
      	var postData = {};
  		     		
      		//请求的数据
			postData.page     = page;//请求的页码
      		postData.pageSize = 10;//每页显示数量 
     		postData.token    = token;
			postData.userType = JsonStorage.getItem('userType');	//2为业务员
			
      		data.postData = postData;  
      		//页面相关数据
      		data.mod      = 'api.sev.index';//模型
      		data.fun      = 'getMsg';//方法
      		data.tpl      = 'msg-list-tpl';//列表模板     		      		
      		data.listId   = 'msgList';//列表容器    
			
			//请求并处理数据
  			loadInfo(data,true,isDown);	     	
	 }	
 
 //消息列表
 function pinglun22(n){
	 openView('../../view/coterie/coterieDetail.html','detail','pop-in',{vid:n});
 }
 
 /**
 	 * 获取求购详情
 	 */
function qiugouDetail(wantId){
 		console.log(wantId)
 		loading('加载中...'); 
		//监控页面是否登录
		if(UserInfo.has_login()){
			var tokenType = JsonStorage.getItem('userType');	//2为业务员	
			 //将请求的数据保存到本地
			var userInfo = JSON.parse(plus.storage.getItem('userInfo'));
			
			if(tokenType!=2&&userInfo.type==1){
				openView('../../view/index/qiugou/detail.html','qiugoudetail','pop-in',{'wantId':wantId});
			}else{
				sw.toast('您没有查看求购详情的权限');	 
				//关闭加载框
				closeLoading();	
			}
			
 		}else{//未登录显示未登录界面
			//关闭加载框
			closeLoading();	
			//顶部 
			sw.toast('您还未登录，请登录后重试'); 
		}
 		
 	}
 	
 	//前往厂商详情
function openFirm(EnterpriseID){
	loading('加载中...'); 
	//监控页面是否登录
	if(UserInfo.has_login()){
		//查看对应的厂商信息
		http.load('api.sev.article','getFirmInfo',{'EnterpriseID':EnterpriseID},function(rData){
			
			dy(rData)  
			if(rData.status==200){ 
				
				var data = rData.data;
				
				var EnterpriseID = data.EnterpriseID;
				var firmName     = data.companyname;
				
				if(data.type==1){//经销商
					
					openJx(EnterpriseID,firmName);
					
				}else{//汽修厂
					
					openQx(EnterpriseID,firmName)
				}
				
			}else{
				sw.toast(rData.msg); 	
			}
			//关闭加载框
			closeLoading();	
			
		},function(xhr,type,errorThrown){
		 		//关闭加载框
				closeLoading();		
				//无网络提示
				sw.toast('获取数据失败，请检查网络'); 	
		}) 
		
	}else{//未登录显示未登录界面
		//关闭加载框
		closeLoading();	
		//顶部 
		sw.toast('您还未登录，请登录后重试'); 
	}
 		
 	}
 
 
 	//页面跳转
	function openJx(EnterpriseID,jxName){	
		
		loading('加载中...'); 
		//监控页面是否登录
		if(UserInfo.has_login()){
			
			var postData = {'EnterpriseID':EnterpriseID,'jxName':jxName};
			//打开窗口
			mui.openWindow({
					    url:'../../view/index/shangjia/jingxiao.html',
					    id:'index_shangjia_jingxiao',//默认使用当前页面的url作为id
					    styles:{},//窗口参数
					    extras:postData//自定义扩展参数
				});
		
		}else{//未登录显示未登录界面
		//关闭加载框
		closeLoading();	
		//顶部 
		sw.toast('您还未登录，请登录后重试'); 
		}
	}
	
	//页面跳转
function openQx(EnterpriseID,qxName){
	loading('加载中...'); 
	//监控页面是否登录
	if(UserInfo.has_login()){
		
		var token   = plus.storage.getItem('token');			
		var postData = {};
			postData.token = token;
		//如果已经登陆 获取登录后的数据
		http.load('api.sev.user','getUserInfo',postData,function(rData){//请求成功
 			//关闭加载框
			closeLoading();				
 			if(rData.status==200){ 	
 				dy(rData);
 				var data = rData.data;	
 				//前往汽修厂确认 
	        	  	qxConfirm(data.is_showfactry,EnterpriseID,qxName)      
 			}else{ 				
 				sw.toast(rData.msg); 	 
 			}
	
 		},function(xhr,type,errorThrown){//请求失败 将之前的数据填入
 			//关闭加载框
			closeLoading();	
			//无网络提示
			sw.toast('请求失败，服务器或网络异常'); 
 		})

	}else{//未登录显示未登录界面
		//关闭加载框
		closeLoading();	
		//顶部 
	  sw.toast('您还未登录，请登录后重试'); 
	}
	
	
	
}  

//汽修提示
function qxConfirm(is_showfactry,EnterpriseID,qxName){
	if(is_showfactry==1){
		var postData = {'EnterpriseID':EnterpriseID,'qxName':qxName};
		openView('../../view/person/repair/detail.html','person_repair_detail','pop-in',postData);
	}else{
		mui.confirm('您无访问权限，可咨询客服了解详情', '&nbsp;', ['<span class="mui-popup-button mui-btn sw-popu-btn" style="color:#333">关闭</span>','<span class="mui-popup-button mui-btn mui-btn-blue sw-popu-btn">客服</span>' ], function(e) {				
			if (e.index == 3&&kefuStatus==1) {//确认
				kefuStatus = 0;
				setTimeout(function(){
					var qqIni = plus.storage.getItem('qqIni');
					window.location.href = 'mqqwpa://im/chat?chat_type=wpa&uin='+qqIni+'&version=1&src_type=web&web_src=qq.com';				
				},300)										
			}	  			
		},'div')
		$('.mui-popup-button').css('font-size','16px');	
		//关闭加载框
		closeLoading();	
	}
}
 </script>
</html>